---
# Ludus role: deploy Wazuh single-node + n8n (Docker)

- name: Ensure base packages are present
  ansible.builtin.apt:
    name:
      - git
      - curl
      - wget
      - ca-certificates
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  become: yes

- name: Set vm.max_map_count for Wazuh
  ansible.builtin.sysctl:
    name: vm.max_map_count
    value: "262144"
    state: present
    reload: yes
  become: yes

######################################################
# Install Docker Engine + Compose plugin (Ubuntu/Debian)
######################################################
- name: Check if docker is already installed
  ansible.builtin.command: docker --version
  register: docker_check
  ignore_errors: yes

- name: Install Docker APT repo prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes
  become: yes
  when: docker_check.rc != 0

- name: Add Docker GPG key directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: yes
  when: docker_check.rc != 0

- name: Download Docker GPG key
  ansible.builtin.get_url:
    url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
    dest: /etc/apt/keyrings/docker.gpg
    mode: "0644"
  become: yes
  when: docker_check.rc != 0

- name: Add Docker APT repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/docker.list
    mode: "0644"
    content: |
      deb [arch={{ ansible_architecture }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable
  become: yes
  when: docker_check.rc != 0

- name: Install Docker Engine and plugins
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: yes
  become: yes
  when: docker_check.rc != 0

- name: Ensure Docker service is enabled and started
  ansible.builtin.service:
    name: docker
    state: started
    enabled: yes
  become: yes

- name: Add current user to docker group
  ansible.builtin.user:
    name: "{{ ansible_user_id }}"
    groups: docker
    append: yes
  become: yes

- name: Relax docker.sock perms for lab (optional)
  ansible.builtin.file:
    path: /var/run/docker.sock
    mode: "0666"
  become: yes
  ignore_errors: yes

############################################
# Create base lab directory
############################################
- name: Create lab directory structure
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
  loop:
    - "/home/{{ ansible_user_id }}/cyber-lab"
    - "/home/{{ ansible_user_id }}/cyber-lab/n8n"
    - "/home/{{ ansible_user_id }}/cyber-lab/wazuh"

######################################################
# Deploy n8n + Postgres (Docker, doc-aligned)
######################################################
- name: Remove any existing n8n containers
  ansible.builtin.command: docker rm -f n8n n8n_postgres
  register: rm_n8n
  ignore_errors: yes
  changed_when: rm_n8n.rc == 0
  become: yes

- name: Remove any existing n8n named volumes
  ansible.builtin.command: docker volume rm n8n_postgres_data n8n_n8n_data
  register: rm_n8n_vol
  ignore_errors: yes
  changed_when: rm_n8n_vol.rc == 0
  become: yes

- name: Clean n8n directory
  ansible.builtin.file:
    path: "/home/{{ ansible_user_id }}/cyber-lab/n8n"
    state: absent
  become: yes

- name: Recreate n8n directory
  ansible.builtin.file:
    path: "/home/{{ ansible_user_id }}/cyber-lab/n8n"
    state: directory
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: "0755"
  become: yes

- name: Generate n8n encryption key
  ansible.builtin.command: openssl rand -hex 16
  register: n8n_enc_key
  changed_when: false

- name: Create n8n .env
  ansible.builtin.copy:
    dest: "/home/{{ ansible_user_id }}/cyber-lab/n8n/.env"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: "0600"
    content: |
      # Postgres
      POSTGRES_USER={{ n8n_postgres_user }}
      POSTGRES_PASSWORD={{ n8n_postgres_password }}
      POSTGRES_DB={{ n8n_postgres_db }}

      # n8n DB config
      DB_TYPE=postgresdb
      DB_POSTGRESDB_HOST=postgres
      DB_POSTGRESDB_PORT=5432
      DB_POSTGRESDB_DATABASE=${POSTGRES_DB}
      DB_POSTGRESDB_USER=${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}

      # n8n basics
      N8N_PORT={{ n8n_port }}
      N8N_HOST=0.0.0.0
      N8N_PROTOCOL=http

      # Disable secure cookie so HTTP/IP works (lab only)
      N8N_SECURE_COOKIE={{ n8n_secure_cookie | ternary('true','false') | lower }}

      # Encryption (must stay stable)
      N8N_ENCRYPTION_KEY={{ n8n_enc_key.stdout }}

      # Timezone
      GENERIC_TIMEZONE={{ n8n_timezone }}
      TZ={{ n8n_timezone }}
  become: yes

- name: Create n8n docker-compose.yml
  ansible.builtin.copy:
    dest: "/home/{{ ansible_user_id }}/cyber-lab/n8n/docker-compose.yml"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: "0644"
    content: |
      version: "3.8"

      services:
        postgres:
          image: postgres:16-alpine
          container_name: n8n_postgres
          restart: unless-stopped
          environment:
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_DB=${POSTGRES_DB}
          volumes:
            - postgres_data:/var/lib/postgresql/data
          healthcheck:
            test: ["CMD-SHELL", "pg_isready -h localhost -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
            interval: 5s
            timeout: 5s
            retries: 10

        n8n:
          image: n8nio/n8n:latest
          container_name: n8n
          restart: unless-stopped
          ports:
            - "{{ n8n_port }}:{{ n8n_port }}"
          environment:
            - DB_TYPE=${DB_TYPE}
            - DB_POSTGRESDB_HOST=${DB_POSTGRESDB_HOST}
            - DB_POSTGRESDB_PORT=${DB_POSTGRESDB_PORT}
            - DB_POSTGRESDB_DATABASE=${DB_POSTGRESDB_DATABASE}
            - DB_POSTGRESDB_USER=${DB_POSTGRESDB_USER}
            - DB_POSTGRESDB_PASSWORD=${DB_POSTGRESDB_PASSWORD}
            - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}
            - N8N_HOST=${N8N_HOST}
            - N8N_PORT=${N8N_PORT}
            - N8N_PROTOCOL=${N8N_PROTOCOL}
            - N8N_SECURE_COOKIE=${N8N_SECURE_COOKIE}
            - GENERIC_TIMEZONE=${GENERIC_TIMEZONE}
            - TZ=${TZ}
          depends_on:
            postgres:
              condition: service_healthy
          volumes:
            - n8n_data:/home/node/.n8n

      volumes:
        postgres_data:
        n8n_data:
  become: yes

- name: Start n8n stack
  ansible.builtin.command: docker compose up -d
  args:
    chdir: "/home/{{ ansible_user_id }}/cyber-lab/n8n"
  become: yes

######################################################
# Deploy Wazuh single-node (Docker)
######################################################
- name: Clone or update wazuh-docker repo
  ansible.builtin.git:
    repo: "{{ wazuh_repo_url }}"
    dest: "/home/{{ ansible_user_id }}/cyber-lab/wazuh/wazuh-docker"
    version: "{{ wazuh_version }}"
    update: yes
  become: no

- name: Generate Wazuh indexer certificates
  ansible.builtin.command: docker compose -f generate-indexer-certs.yml run --rm generator
  args:
    chdir: "/home/{{ ansible_user_id }}/cyber-lab/wazuh/wazuh-docker/single-node"
  become: yes

- name: Start Wazuh single-node stack
  ansible.builtin.command: docker compose up -d
  args:
    chdir: "/home/{{ ansible_user_id }}/cyber-lab/wazuh/wazuh-docker/single-node"
  become: yes

######################################################
# Connect n8n to Wazuh Docker network
######################################################
- name: Find Wazuh single-node Docker network
  ansible.builtin.command: docker network ls --filter "name=single-node" --format "{{ '{{' }}.Name{{ '}}' }}"
  register: wazuh_net
  changed_when: false
  failed_when: false
  become: yes

- name: Connect n8n container to Wazuh network
  ansible.builtin.command: docker network connect "{{ wazuh_net.stdout_lines[0] }}" n8n
  when:
    - wazuh_net.stdout_lines | length > 0
  ignore_errors: yes
  become: yes
